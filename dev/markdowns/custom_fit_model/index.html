<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Creating a custom fit_model() function · ActionModels.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://ilabcode.github.io/ActionModels.jl/markdowns/custom_fit_model/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../Introduction/">ActionModels.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><span class="tocitem">Introduction to Action Models</span><ul><li><a class="tocitem" href="../Introduction/">Welcome to the ActionModels.jl package!</a></li><li><a class="tocitem" href="../../Conceptual_introduction/agent_and_actionmodel/">Agents, states and action models</a></li><li><a class="tocitem" href="../../Conceptual_introduction/fitting_vs_simulating/">Fitting and simulating</a></li></ul></li><li><span class="tocitem">Creating Your Model</span><ul><li><a class="tocitem" href="../creating_own_action_model/">Building your own action model</a></li><li><a class="tocitem" href="../premade_agents_and_models/">Creating your agent using premade agents and models in the ActionModels package</a></li></ul></li><li><span class="tocitem">Agent Based Simulation</span><ul><li><a class="tocitem" href="../Simulation_with_an_agent/">Simulating actions with an agent</a></li><li><a class="tocitem" href="../variations_of_util/">Variations of utility functions</a></li></ul></li><li><span class="tocitem">Fitting an Agent Model</span><ul><li><a class="tocitem" href="../fitting_an_agent_model_to_data/">Fitting an agent model to data</a></li><li><a class="tocitem" href="../prior_predictive_sim/">Predictive Simulations</a></li></ul></li><li><span class="tocitem">Advanced Usage</span><ul><li class="is-active"><a class="tocitem" href>Creating a custom fit_model() function</a><ul class="internal"><li><a class="tocitem" href="#Strucure-of-create_agent_model-is-the-following:"><span>Strucure of create_agent_model is the following:</span></a></li><li class="toplevel"><a class="tocitem" href="#we-start-by-specifying-function-name-and-the-inputs"><span>we start by specifying function name and the inputs</span></a></li><li class="toplevel"><a class="tocitem" href="###-Strucure-of-fit_model()"><span>## Strucure of fit_model()</span></a></li><li class="toplevel"><a class="tocitem" href="#The-different-elements-in-the-code-are-seperated."><span>The different elements in the code are seperated.</span></a></li><li class="toplevel"><a class="tocitem" href="#start-by-inititializing-function-name-an-inputs"><span>start by inititializing function name an inputs</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Advanced Usage</a></li><li class="is-active"><a href>Creating a custom fit_model() function</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Creating a custom fit_model() function</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ilabcode/ActionModels.jl/blob/main/docs/src/Using_the_package/custom_fit_model.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Creating-a-custom-fit_model()-function"><a class="docs-heading-anchor" href="#Creating-a-custom-fit_model()-function">Creating a custom fit_model() function</a><a id="Creating-a-custom-fit_model()-function-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-a-custom-fit_model()-function" title="Permalink"></a></h1><p>If you wish to alter the fit_model() function to you own specific use case we have provided a compact version of the function with the basic structure for you to work on.</p><h2 id="Strucure-of-create_agent_model-is-the-following:"><a class="docs-heading-anchor" href="#Strucure-of-create_agent_model-is-the-following:">Strucure of create_agent_model is the following:</a><a id="Strucure-of-create_agent_model-is-the-following:-1"></a><a class="docs-heading-anchor-permalink" href="#Strucure-of-create_agent_model-is-the-following:" title="Permalink"></a></h2><h1 id="we-start-by-specifying-function-name-and-the-inputs"><a class="docs-heading-anchor" href="#we-start-by-specifying-function-name-and-the-inputs">we start by specifying function name and the inputs</a><a id="we-start-by-specifying-function-name-and-the-inputs-1"></a><a class="docs-heading-anchor-permalink" href="#we-start-by-specifying-function-name-and-the-inputs" title="Permalink"></a></h1><p>@model function create<em>agent</em>model(     agent,     param<em>priors,     inputs,     actions,     impute</em>missing_actions, )</p><pre><code class="nohighlight hljs">##Initialize dictionary for storing sampled parameters
fitted_parameters = Dict()

##--------- Sample parameters from the priors set, and set the parameters in the agent ---------

##Give Turing prior distributions for each fitted parameter
for (param_key, param_prior) in param_priors
    fitted_parameters[param_key] ~ param_prior
end

##Set agent parameters to the sampled values
set_parameters!(agent, fitted_parameters)
reset!(agent)

## ----------- Specify settings for whether inputs are as vectors or arrays ---------

##If the input is a single vector
if inputs isa Vector
    ##Prepare to through one value at a time
    iterator = enumerate(inputs)
else
    ##For an array, go through each row
    iterator = enumerate(eachrow(inputs))
end

## ---------- Go through inputs and get the action probability distribution from the agent ------

##For each timestep and input
for (timestep, input) in iterator
    ##If no errors occur
    try

        ##Get the action probability distribution from the action model
        action_probability_distribution = agent.action_model(agent, input)

        ## ---- if one single action is made at each timestep (if only one action model is specified in the configurations ) ----

        if actions isa Vector

            ##If the action isn&#39;t missing, or if missing actions are to be imputed
            if !ismissing(actions[timestep]) || impute_missing_actions
                #Pass it to Turing
                actions[timestep] ~ action_probability_distribution
            end

            ## ---- if multiple actions are made at each timestep (if more action models are specified in the configurations ) ----

        elseif actions isa Array

            ##Go throgh each action distribution
            for (action_indx, distribution) in
                enumerate(action_probability_distribution)

                ##If the action isn&#39;t missing, or if missing actions are to be imputed
                if !ismissing(actions[timestep, action_indx]) || impute_missing_actions
                    ##Pass it to Turing
                    actions[timestep, action_indx] ~ distribution
                end
            end
        end

        ##--------- If an error occurs -----------

    catch e
        ##If the custom errortype RejectParameters occurs
        if e isa RejectParameters
            ##Make Turing reject the sample
            Turing.@addlogprob!(-Inf)
        else
            ##Otherwise, just throw the error
            throw(e)
        end
    end
end</code></pre><p>end</p><h1 id="-Strucure-of-fit_model()"><a class="docs-heading-anchor" href="###-Strucure-of-fit_model()">## Strucure of fit_model()</a><a id="-Strucure-of-fit_model()-1"></a><a class="docs-heading-anchor-permalink" href="###-Strucure-of-fit_model()" title="Permalink"></a></h1><h1 id="The-different-elements-in-the-code-are-seperated."><a class="docs-heading-anchor" href="#The-different-elements-in-the-code-are-seperated.">The different elements in the code are seperated.</a><a id="The-different-elements-in-the-code-are-seperated.-1"></a><a class="docs-heading-anchor-permalink" href="#The-different-elements-in-the-code-are-seperated." title="Permalink"></a></h1><h1 id="start-by-inititializing-function-name-an-inputs"><a class="docs-heading-anchor" href="#start-by-inititializing-function-name-an-inputs">start by inititializing function name an inputs</a><a id="start-by-inititializing-function-name-an-inputs-1"></a><a class="docs-heading-anchor-permalink" href="#start-by-inititializing-function-name-an-inputs" title="Permalink"></a></h1><p>function fit<em>model(     agent::Agent,     param</em>priors::Dict,     inputs::Array,     actions::Array;     fixed<em>parameters::Dict = Dict(),     sampler = NUTS(),     n</em>cores::Integer = 1,     n<em>iterations::Integer = 1000,     n</em>chains = 2,     verbose = true,     show<em>sample</em>rejections = false,     impute<em>missing</em>actions::Bool = false, )     ##Store old parameters for resetting the agent later     old<em>parameters = get</em>parameters(agent)</p><pre><code class="nohighlight hljs">## -------------- CHECKS START ---------------- #

##Unless warnings are hidden
if verbose
    ##If there are any of the agent&#39;s parameters which have not been set in the fixed or sampled parameters
    if any(
        key -&gt; !(key in keys(param_priors)) &amp;&amp; !(key in keys(fixed_parameters)),
        keys(old_parameters),
    )
        @warn &quot;the agent has parameters which are not specified in the fixed or sampled parameters. The agent&#39;s current parameter values are used as fixed parameters&quot;
    end

    ##If a parameter has been specified both in the fixed and sampled parameters
    if any(key -&gt; key in keys(fixed_parameters), keys(param_priors))
        @warn &quot;one or more parameters have been specified both in the fixed and sampled parameters. The fixed parameter value is used&quot;

        ##Remove the parameter from the sampled parameters
        for key in keys(fixed_parameters)
            if key in keys(param_priors)
                delete!(param_priors, key)
            end
        end
    end
end

##If there are no parameters to sample
if length(param_priors) == 0
    ##Throw an error
    throw(
        ArgumentError(
            &quot;no parameters to sample. Either an empty dictionary of parameter priors was passed, or all parameters with priors were also specified as fixed parameters&quot;,
        ),
    )
end

##If there are different amounts of inputs and actions
if size(inputs, 1) != size(actions, 1)
    throw(
        ArgumentError(
            &quot;there are different amounts of inputs and actions (they differ in their first dimension). This is not supported&quot;,
        ),
    )
end

### Set fixed parameters to agent ###
set_parameters!(agent, fixed_parameters)

### Run forward once ###
##Initialize dictionary for populating with median parameter values
sampled_parameters = Dict()
##Go through each of the agent&#39;s parameters
for (param_key, param_prior) in param_priors
    ##Add the median value to the tuple
    sampled_parameters[param_key] = median(param_prior)
end
##Set sampled parameters
set_parameters!(agent, sampled_parameters)
##Reset the agent
reset!(agent)

try
    ##Run it forwards
    test_actions = give_inputs!(agent, inputs)

    ##If the model returns a different amount of actions from what was inputted
    if size(test_actions) != size(actions)
        throw(
            ArgumentError(
                &quot;the passed actions is a different shape from what the model returns&quot;,
            ),
        )
    end

catch e
    ##If a RejectParameters error occurs
    if e isa RejectParameters
        ##Warn the user that prior median parameter values gives a sample rejection
        if verbose
            @warn &quot;simulating with median parameter values from the prior results in a rejected sample.&quot;
        end
    else
        ##Otherwise throw the actual error
        throw(e)
    end
end

##--------------- FIT MODEL START ----------- #

##------- Fit model with one core specified ------ #

##If only one core is specified, use sequentiel sampling
if n_cores == 1

    ##Initialize Turing model
    model =
        create_agent_model(agent, param_priors, actions, inputs, impute_missing_actions)

    ##If sample rejection warnings are to be shown
    if show_sample_rejections
        ##Fit model to inputs and actions, as many separate chains as specified
        chains = map(i -&gt; sample(model, sampler, n_iterations), 1:n_chains)

        ##If sample rejection warnings are not to be shown
    else
        ##Create a logger which ignores messages below error level
        sampling_logger = Logging.SimpleLogger(Logging.Error)
        ##Use that logger
        chains = Logging.with_logger(sampling_logger) do

            ##Fit model to inputs and actions, as many separate chains as specified
            map(i -&gt; sample(model, sampler, n_iterations), 1:n_chains)
        end
    end

    ##------- Fit model with one multiple cores specified ------ #

elseif n_cores &gt; 1

    ##If the user has already created processsses
    if length(procs()) == 1
        ##Add worker processes
        addprocs(n_cores, exeflags = &quot;--project&quot;)

        ##Set flag to remove the workers later
        remove_workers_at_end = true
    else
        ##Error
        @warn &quot;&quot;&quot;
        n_cores was set to &gt; 1, but workers have already been created. No new workers were created, and the existing ones are used for parallelization.
        Note that the following variable names are broadcast to the workers: sampler agent param_priors inputs actions impute_missing_actions
        &quot;&quot;&quot;
        #Set flag to not remove the workers later
        remove_workers_at_end = false
    end

    ##------ Setup distribution of information to processes for parallellization -----

    ##Load packages on worker processes
    @everywhere @eval using ActionModels
    @everywhere @eval using Turing

    ##Broadcast necessary information to workers
    @everywhere sampler = $sampler
    @everywhere agent = $agent
    @everywhere param_priors = $param_priors
    @everywhere inputs = $inputs
    @everywhere actions = $actions
    @everywhere impute_missing_actions = $impute_missing_actions

    ##----- fit model to inputs with shown sample rejection warnings ------

    if show_sample_rejections
        ##Fit model to inputs and actions, as many separate chains as specified
        chains = pmap(
            i -&gt; sample(
                create_agent_model(
                    agent,
                    param_priors,
                    inputs,
                    actions,
                    impute_missing_actions,
                ),
                sampler,
                n_iterations,
                save_state = false,
            ),
            1:n_chains,
        )

        ##----- fit model to inputs not showing sample rejection warnings ------

    else
        ##Create a logger which ignores messages below error level
        sampling_logger = Logging.SimpleLogger(Logging.Error)
        ##Use that logger
        chains = Logging.with_logger(sampling_logger) do

            ##Fit model to inputs and actions, as many separate chains as specified
            pmap(
                i -&gt; sample(
                    create_agent_model(
                        agent,
                        param_priors,
                        inputs,
                        actions,
                        impute_missing_actions,
                    ),
                    sampler,
                    n_iterations,
                    save_state = false,
                ),
                1:n_chains,
            )
        end
    end

    ## ----- end configurations: worker cleanup and combining chains -------
    ##If workers are to be removed
    if remove_workers_at_end
        ##Remove workers
        rmprocs(workers())
    end

else
    throw(
        ArgumentError(
            &quot;n_cores was set to a non-positive integer. This is not supported.&quot;,
        ),
    )
end

##Concatenate chains together
chains = chainscat(chains...)

##-------------- CLEANUP ----------------

##Reset the agent to its original parameters
set_parameters!(agent, old_parameters)
reset!(agent)

##Turing includes the dictionary name &#39;fitted_parameters&#39; in the parameter names, so it must be removed
##Initialize dict for replacement names
replacement_param_names = Dict()
##For each parameter
for param_key in keys(param_priors)
    ##Set to replace the fitted_parameters[] version with just the parameter name
    replacement_param_names[&quot;fitted_parameters[$param_key]&quot;] = param_key
end
##Input the dictionary to replace the names
chains = replacenames(chains, replacement_param_names)

return chains</code></pre><p>end</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../prior_predictive_sim/">« Predictive Simulations</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Monday 13 February 2023 10:15">Monday 13 February 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
